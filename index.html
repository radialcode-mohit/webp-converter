<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image to WebP Converter</title>
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <div class="container">
        <input type="file" id="imageInput" accept="image/*" multiple>
        <button id="convertButton">Convert to WebP</button>
    </div>
    <script>// script.js
        // script.js
        document.getElementById('convertButton').addEventListener('click', function () {
            const files = document.getElementById('imageInput').files;
            if (files.length === 0) {
                alert('Please select one or more images.');
                return;
            }

            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = function (event) {
                    const img = new Image();
                    img.onload = function () {
                        const maxWidth = 800; // Maximum width for the resized image
                        const maxHeight = 800; // Maximum height for the resized image
                        let imgWidth = img.width;
                        let imgHeight = img.height;

                        // Resize if necessary while maintaining aspect ratio
                        if (imgWidth > imgHeight) {
                            if (imgWidth > maxWidth) {
                                imgHeight *= maxWidth / imgWidth;
                                imgWidth = maxWidth;
                            }
                        } else {
                            if (imgHeight > maxHeight) {
                                imgWidth *= maxHeight / imgHeight;
                                imgHeight = maxHeight;
                            }
                        }

                        const canvas = document.createElement('canvas');
                        canvas.width = imgWidth;
                        canvas.height = imgHeight;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, imgWidth, imgHeight);

                        // Try different quality settings if the initial conversion is too large
                        const qualitySteps = [0.9, 0.8, 0.7, 0.6, 0.5, 0.4, 0.3, 0.2, 0.1];
                        let resultQuality;

                        for (let quality of qualitySteps) {
                            canvas.toBlob(function (blob) {
                                if (blob.size <= 50 * 1024) { // Check if blob size is less than 50 KB
                                    resultQuality = quality;
                                    downloadBlob(blob, file.name); // Download the blob with a unique name
                                    return;
                                }
                            }, 'image/webp', quality);
                        }

                        if (!resultQuality) {
                            console.log('Unable to compress some images to below 50 KB.');
                        }
                    };
                    img.src = event.target.result;
                };
                reader.readAsDataURL(file);
            });
        });

        function downloadBlob(blob, originalName) {
            const timestamp = new Date().getTime(); // Get current timestamp
            const filename = originalName.replace(/\.\w+$/, '') + '_' + timestamp + '.webp'; // Append timestamp to the original file name

            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = filename; // Use the unique filename for downloading
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
        }

    </script>
</body>

</html>